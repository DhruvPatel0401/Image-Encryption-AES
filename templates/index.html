<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Encryption/Decryption</title>
</head>
<body>
    <h1>Image Encryption/Decryption</h1>
    <div>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password">
    </div>
    <div>
        <label for="image">Image:</label>
        <input type="file" id="image" name="image" accept="image/*">
    </div>
    <button type="button" onclick="encryptImage()">Encrypt</button>
    <button type="button" onclick="decryptImage()">Decrypt</button>
    <script>
        function encryptImage() {
            var password = document.getElementById('password').value;
            var image = document.getElementById('image').files[0];
            
            var formData = new FormData();
            formData.append('password', password);
            formData.append('image', image);

            fetch('/encrypt/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // Parse response as text
            })
            .then(encodedImgData => {
                // Decode Base64 encoded image data
                var decodedImgData = atob(encodedImgData);

                // Convert binary string to Uint8Array
                var imgDataArray = new Uint8Array(decodedImgData.length);
                for (var i = 0; i < decodedImgData.length; i++) {
                    imgDataArray[i] = decodedImgData.charCodeAt(i);
                }

                // Create Blob from Uint8Array
                var blob = new Blob([imgDataArray], { type: 'image/jpeg' });

                // Create Blob URL for the Blob
                var blobUrl = URL.createObjectURL(blob);

                // Create an <a> element
                var a = document.createElement('a');

                // Set attributes for the <a> element
                a.href = blobUrl;
                a.download = 'encrypted_image.jpg';

                // Simulate click on the <a> element to trigger download
                a.click();

                // Clean up by revoking the Blob URL after download is complete
                a.addEventListener('click', function() {
                    URL.revokeObjectURL(blobUrl);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }


        function decryptImage() {
            var password = document.getElementById('password').value;
            var image = document.getElementById('image').files[0];
            
            var formData = new FormData();
            formData.append('password', password);
            formData.append('image', image);

            fetch('/decrypt/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob(); // Parse response as Blob
            })
            .then(blob => {
                // Create a URL for the Blob
                var imageUrl = URL.createObjectURL(blob);

                // Create an <a> element
                var a = document.createElement('a');

                // Set attributes for the <a> element
                a.href = imageUrl;
                a.download = 'decrypted_image.jpg';

                // Simulate click on the <a> element to trigger download
                a.click();

                // Clean up by revoking the Blob URL after download is complete
                a.addEventListener('click', function() {
                    URL.revokeObjectURL(imageUrl);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
